---
title: "Météo Montpeul"
jupyter: python3
---

Voici la météo à Montpellier pour aujourd'hui et les 3 prochains jours :

```{python}
#| echo: false
import datetime
import pandas as pd
import matplotlib.pyplot as plt
from modules.data_loader import download_csv, load_csv
from PIL import Image
import json
from modules.formatters import rename_columns, add_units, format_dates

# --- Dates ---
aujourd_hui = datetime.date.today()
fin = aujourd_hui + datetime.timedelta(days=3)

# --- Téléchargement des données météo ---
url_daily = (
    f"https://api.open-meteo.com/v1/meteofrance?"
    f"latitude=43.6109&longitude=3.8763&"
    f"daily=weathercode,temperature_2m_max,temperature_2m_min,precipitation_sum,"
    f"windspeed_10m_max,winddirection_10m_dominant&"
    f"timezone=GMT&start_date={aujourd_hui}&end_date={fin}&format=csv"
)
url_hourly = (
    f"https://api.open-meteo.com/v1/meteofrance?"
    f"latitude=43.6109&longitude=3.8763&"
    f"hourly=windspeed_10m&start_date={aujourd_hui}&end_date={fin}&format=csv"
)

# Téléchargement avec timeout
download_csv(url_daily, "./data/db_day.csv")
download_csv(url_hourly,"./data/db_hour.csv")

# --- Lecture des CSV ---
df_day = pd.read_csv("./data/db_day.csv", skiprows=3).fillna("-")
df_hour = pd.read_csv("./data/db_hour.csv", skiprows=3)
df_hour.rename(columns={"windspeed_10m (km/h)": "vent"}, inplace=True)

# Renommer les colonnes de df pour plus de clarté
df_day = rename_columns(df_day)

#valeur de la pluie pour l'affichage des gouttes
pluie = df_day['pluie'].tolist()

#ajout des unités
df_day = add_units(df_day)

#On transpose la dataframe
df_day = df_day.T

#calcul du vent moyen et remplacement de la valeur dans db
for i in range(4):
    subset = df_hour.loc[24*i : 24*(i+1)-1]
    value = round(subset['vent'].mean() , 1)
    df_day.iloc[5,i] = str(df_day.iloc[5,i]) + ' km/h'

#Création du tableau contenant les informations voulues
fig = plt.figure(figsize=(14,10), dpi=60)
ax = plt.subplot()

ncols = df_day.shape[1]
nrows = df_day.shape[0] - 1

ax.set_xlim(0, ncols + 1)
ax.set_ylim(0, nrows)
ax.set_axis_off()

columns = df_day.iloc[0].tolist()

# création des dates (nom du jour/numéro/mois)
df_day = format_dates(df_day)

#nom des colonnes
for i in range(ncols):
        ha = 'center'
        ax.annotate(
            xy=(i+1, nrows-0.7),
            text=df_day.iloc[0,i],
            ha=ha,
            va='bottom',
            weight='bold',
            fontsize = 15
        )


for j, column in enumerate(columns):
        ha = 'center'
        ax.annotate(
            xy = (j+1, nrows - 2),
            text = df_day.iloc[2,j],
            ha = ha,
            va = 'center',
            weight='bold',
            fontsize = 12 ,
            bbox=dict(boxstyle="round4",pad = 0.8, fc="indianred")
        )

for j, column in enumerate(columns):
        ha = 'center'
        ax.annotate(
            xy = (j+1, nrows - 3),
            text = df_day.iloc[3,j],
            ha = ha,
            va = 'center',
            weight='bold',
            fontsize = 12 ,
            bbox=dict(boxstyle="round4", pad = 0.8, fc="lightblue")
        )

# Ajout du reste des valeurs dans le tableau
for i in range(4,nrows):
    for j, column in enumerate(columns):
        ha = 'center'
        ax.annotate(
            xy = (j+1, nrows - i),
            text = df_day.iloc[i,j],
            ha = ha,
            weight='bold',
            fontsize = 12 ,
            va = 'center'
        )

#création des lignes de séparations
ax.plot([0.5, 4.5], [nrows, nrows], lw=6, color='black', marker='', zorder=4)
ax.plot([0.5, 4.5], [0.5, 0.5], lw=6, color='black', marker='', zorder=4)
for x in range(1, nrows - 1):
    ax.plot([0.5, 4.5], [x+0.5, x + 0.5], lw=1.15, color='gray', ls=':', zorder=3 , marker='')


#Transformation en différents type de coordonnées
DC_to_FC = ax.transData.transform
FC_to_NFC = fig.transFigure.inverted().transform

# Take data coordinates and transform them to normalized figure coordinates
DC_to_NFC = lambda x: FC_to_NFC(DC_to_FC(x))

# Ajout des images du temps
ax_point_1 = DC_to_NFC([0.25, 0.25])
ax_point_2 = DC_to_NFC([0.75, 0.75])
ax_width = abs(ax_point_1[0] - ax_point_2[0])*2
ax_height = abs(ax_point_1[1] - ax_point_2[1])*2

# fichier json des icones
with open("./data/ic.json", "r") as icone: 
    df_ic = json.load(icone)

for i in range(ncols):
    ax_coords = DC_to_NFC([i + 0.5, 4.4])
    ico_ax = fig.add_axes([ax_coords[0], ax_coords[1], ax_width, ax_height])
    image_code(df.iloc[1,i], ico_ax)



#Ajout des gouttes d'eau
gt_point_1 = DC_to_NFC([0.25, 0.25])
gt_point_2 = DC_to_NFC([0.5, 0.5])
gt_width = abs(gt_point_1[0] - gt_point_2[0])
gt_height = abs(gt_point_1[1] - gt_point_2[1])
for i in range(ncols):
    ax_coords = DC_to_NFC([ i + 0.55 , 1.9])
    if type(pluie[i]) == float and pluie[i]>= 0:
        goutte_ax = fig.add_axes(
        [ax_coords[0], ax_coords[1], gt_width, gt_height]
    )
        image = Image.open("./data/goutte.png")
        goutte_ax.axis('off')
        goutte_ax.imshow(image)

#Ajout des directions du vent
v_point_1 = DC_to_NFC([0.25, 0.25])
v_point_2 = DC_to_NFC([0.4, 0.4])
v_width = abs(v_point_1[0] - v_point_2[0])
v_height = abs(v_point_1[1] - v_point_2[1])
for i in range(ncols):
    if type(df.iloc[6,i]) == float and df.iloc[6,i]>= 0:
        ax_coords = DC_to_NFC([ i + 0.55 , 0.9])
        vent_ax = fig.add_axes(
        [ax_coords[0], ax_coords[1], v_width, v_height]
        ) 
        vent = Image.open("./data/vent.png")
        vent = vent.rotate(-df.iloc[6,i])
        vent_ax.axis('off')
        vent_ax.imshow(vent)

plt.savefig(
    'meteo.svg',
    dpi=60,
    transparent=True)
```

```{python}
#| echo: false
date = datetime.date.today() 
heure = datetime.datetime.now().strftime('%H:%M:%S')
print(f"Site généré le {date} à {heure}" )
```